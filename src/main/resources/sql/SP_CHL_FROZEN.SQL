--call MPOS.SP_CHL_FROZEN('05','384984159660',?)
--DROP PROCEDURE SP_CHL_FROZEN;
CREATE PROCEDURE "MPOS"."SP_CHL_FROZEN" (
--CREATE OR REPLACE PROCEDURE "MPOS"."SP_CHL_FROZEN" (
    IN "I_CHLNO"	VARCHAR(50),	--05 微信二清，10 支付宝二清，20 百付宝
    IN "I_BATNO"	DEC(20),
    OUT "O_ERRMSG"	VARCHAR(128)
)
LANGUAGE SQL
BEGIN 
/*=====================================================================+           
  功能描述：移动收单冻结解冻清单
            
  编写人员：phio
  设计日期：2017/03/29
  修改历史：
  修改日期  修改人员   修改原因
  20170419  LINYQ      多机构接入改造 BAT2_CMP_CHL_FROZEN 表中增加 BANK_CODE 字段;
-----------------------------------------------------------------------*/

--------------------------常用变量定义--------------------------
DECLARE IRET INTEGER DEFAULT 0 ;
--定义SQL异常警告信息捕捉变量
DECLARE SQLCODE INT DEFAULT 0 ;		        --SQL返回代码
DECLARE SQLSTATE CHAR(5) DEFAULT '00000' ;--SQL默认返回代码'00000'，返回成功
--------------------------应用变量定义---------------------------


----------------------------------异常日志处理-------------------------
--SQL产生的非上述异常的处理
DECLARE EXIT HANDLER FOR SQLEXCEPTION 
BEGIN
	SET O_ERRMSG = O_ERRMSG ||',SQLCODE='||TRIM(CHAR(SQLCODE))||',SQLSTATE='||SQLSTATE;	
	--ROLLBACK ;
END;

SET O_ERRMSG = '-1';
--补全我方字段信息（T-1部分）BAT2_CMP_MPOS_DTL
MERGE INTO (SELECT * FROM BAT2_CMP_CHL_FROZEN WHERE BNO=I_BATNO AND MCH_ORDER_ID IS NULL) T USING BAT2_CMP_MPOS_DTL S
	ON T.MY_ORDER_ID = S.MY_ORDER_ID
	WHEN MATCHED THEN
		UPDATE SET T.MY_MCH_NO=S.MY_MCH_NO,T.MY_SEC_MCH_NO=S.MY_SEC_MCH_NO,T.MCH_ORDER_ID=S.MCH_ORDER_ID, T.BANK_CODE = S.BANK_CODE
	ELSE IGNORE;	
		
SET O_ERRMSG = '-2';
--补全我方字段信息（T-1部分）BAT2_CMP_MPOS_DTL_FAIL
MERGE INTO (SELECT * FROM BAT2_CMP_CHL_FROZEN WHERE BNO=I_BATNO AND MCH_ORDER_ID IS NULL) T USING BAT2_CMP_MPOS_DTL_FAIL S
	ON T.MY_ORDER_ID = S.MY_ORDER_ID
	WHEN MATCHED THEN
		UPDATE SET T.MY_MCH_NO=S.MY_MCH_NO,T.MY_SEC_MCH_NO=S.MY_SEC_MCH_NO,T.MCH_ORDER_ID=S.MCH_ORDER_ID, T.BANK_CODE = S.BANK_CODE
	ELSE IGNORE;	

SET O_ERRMSG = '-3';
--补全我方字段信息（小于T-1日的，即解冻信息）
MERGE INTO (SELECT * FROM BAT2_CMP_CHL_FROZEN WHERE BNO=I_BATNO AND MCH_ORDER_ID IS NULL AND FROZ_FG='U') T USING BAT2_CMP_CHL_FROZEN S
	ON T.MY_ORDER_ID = S.MY_ORDER_ID AND S.FROZ_FG='F'
	WHEN MATCHED AND S.MCH_ORDER_ID IS NOT NULL THEN
		UPDATE SET T.MY_MCH_NO=S.MY_MCH_NO,T.MY_SEC_MCH_NO=S.MY_SEC_MCH_NO,T.MCH_ORDER_ID=S.MCH_ORDER_ID, T.BANK_CODE = S.BANK_CODE
	ELSE IGNORE;	


COMMIT;
SET O_ERRMSG = '0';

END;
